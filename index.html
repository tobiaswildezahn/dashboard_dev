<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTW Hilfsfrist Dashboard - Hamburger Feuerwehr</title>

    <!-- ArcGIS JavaScript API -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- CSS Modules (loaded in order) -->
    <link rel="stylesheet" href="css/01-variables.css">
    <link rel="stylesheet" href="css/02-base.css">
    <link rel="stylesheet" href="css/03-header.css">
    <link rel="stylesheet" href="css/04-filters.css">
    <link rel="stylesheet" href="css/05-kpi-cards.css">
    <link rel="stylesheet" href="css/06-charts.css">
    <link rel="stylesheet" href="css/07-table.css">
    <link rel="stylesheet" href="css/08-modal.css">
    <link rel="stylesheet" href="css/09-responsive.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Message Toast -->
    <div class="message-toast" id="messageToast"></div>

    <!-- Modal f√ºr Einsatzdetails -->
    <div class="modal-overlay" id="eventDetailsModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">
                    <span>üö®</span>
                    <span>Einsatzdetails</span>
                </div>
                <button class="modal-close-btn" onclick="closeEventDetailsModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBodyContent">
                <div class="modal-loading">
                    <div class="modal-loading-spinner"></div>
                    <div>Lade Einsatzdetails...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <div class="header-icon">üöë</div>
                <div class="header-text">
                    <h1>RTW Hilfsfrist-Dashboard V7</h1>
                    <p>Hamburger Feuerwehr - Echtzeit-Monitoring (Modular Edition)</p>
                </div>
            </div>
            <div class="header-status">
                <div class="status-item">
                    <div class="status-indicator active"></div>
                    <span class="status-text">Live-Daten</span>
                </div>
                <div class="status-item">
                    <span class="status-text" id="lastUpdate">L√§dt...</span>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel">
            <div class="filter-header">
                <h2>üîç Filter & Einstellungen</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="refreshBtn">
                        üîÑ Aktualisieren
                    </button>
                    <button class="btn btn-secondary" id="exportBtn">
                        üì• CSV Export
                    </button>
                </div>
            </div>

            <div class="filter-controls">
                <div class="form-group">
                    <label for="timeFilter">Zeitraum</label>
                    <select id="timeFilter">
                        <option value="3">Letzte 3 Stunden</option>
                        <option value="6">Letzte 6 Stunden</option>
                        <option value="12">Letzte 12 Stunden</option>
                        <option value="24" selected>Letzte 24 Stunden</option>
                        <option value="48">Letzte 48 Stunden</option>
                        <option value="72">Letzte 72 Stunden</option>
                        <option value="current-shift">Aktuelle Schicht (07:00-07:00)</option>
                    </select>
                </div>
            </div>

            <!-- RTW Picker Section -->
            <div class="rtw-picker-section">
                <div class="rtw-picker-header" id="rtwPickerToggle">
                    <h3>üöë RTW-Auswahl <span id="rtwSelectedCount">(Alle ausgew√§hlt)</span></h3>
                    <span class="rtw-picker-toggle">‚ñº</span>
                </div>
                <div class="rtw-picker-content" id="rtwPickerContent">
                    <div class="rtw-picker-actions">
                        <button class="rtw-picker-btn select-all" id="selectAllRtwBtn">Alle ausw√§hlen</button>
                        <button class="rtw-picker-btn deselect-all" id="deselectAllRtwBtn">Alle abw√§hlen</button>
                    </div>
                    <div class="rtw-checkbox-grid" id="rtwCheckboxGrid">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <!-- Gesamteins√§tze KPI -->
            <div class="kpi-card info">
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Gesamteins√§tze</div>
                    </div>
                    <div class="kpi-icon">üìã</div>
                </div>
                <div class="kpi-value-large">
                    <span id="totalCount">0</span>
                </div>
                <div class="kpi-breakdown">
                    <div class="kpi-breakdown-item">
                        <div class="kpi-breakdown-label">‚úÖ Hilfsfristrelevant</div>
                        <div class="kpi-breakdown-value">
                            <span class="kpi-breakdown-number" id="relevantCount">0</span>
                            <span class="kpi-breakdown-percentage" id="relevantPercentage">(0%)</span>
                        </div>
                    </div>
                    <div class="kpi-breakdown-item">
                        <div class="kpi-breakdown-label">üö´ Nicht relevant</div>
                        <div class="kpi-breakdown-value">
                            <span class="kpi-breakdown-number" id="notRelevantCount">0</span>
                            <span class="kpi-breakdown-percentage" id="notRelevantPercentage">(0%)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ausr√ºckezeit KPI -->
            <div class="kpi-card success" id="responseCard">
                <span class="kpi-status-badge" id="responseStatusBadge"></span>
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Ausr√ºckezeit</div>
                        <div class="kpi-label">‚â§ 90 Sekunden</div>
                    </div>
                    <div class="kpi-icon">‚è±Ô∏è</div>
                </div>
                <div class="kpi-value">
                    <span id="responsePercentage">0</span>%
                </div>
                <div class="kpi-label">
                    <span id="responseAchieved">0</span> von <span id="responseTotal">0</span> erreicht
                </div>
                <div class="kpi-label" style="margin-top: 6px; color: var(--gray-500); font-size: 11px;">
                    üìä 90% Perzentil: <strong id="response90Percentile" style="color: var(--gray-700);">N/A</strong>
                </div>
                <div class="kpi-threshold-info" id="responseThresholdInfo">
                    ‚ö´ Status wird berechnet...
                </div>
            </div>

            <!-- Anfahrtszeit KPI -->
            <div class="kpi-card warning" id="travelCard">
                <span class="kpi-status-badge" id="travelStatusBadge"></span>
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Anfahrtszeit</div>
                        <div class="kpi-label">‚â§ 5 Minuten</div>
                    </div>
                    <div class="kpi-icon">üöó</div>
                </div>
                <div class="kpi-value">
                    <span id="travelPercentage">0</span>%
                </div>
                <div class="kpi-label">
                    <span id="travelAchieved">0</span> von <span id="travelTotal">0</span> erreicht
                </div>
                <div class="kpi-label" style="margin-top: 6px; color: var(--gray-500); font-size: 11px;">
                    üìä 90% Perzentil: <strong id="travel90Percentile" style="color: var(--gray-700);">N/A</strong>
                </div>
                <div class="kpi-threshold-info" id="travelThresholdInfo">
                    ‚ö´ Status wird berechnet...
                </div>
            </div>

            <!-- Hilfsfrist KPI -->
            <div class="kpi-card" id="hilfsfristCard">
                <span class="kpi-status-badge" id="hilfsfristStatusBadge"></span>
                <div class="kpi-header">
                    <div>
                        <div class="kpi-title">Hilfsfrist</div>
                        <div class="kpi-label">Gesamt</div>
                    </div>
                    <div class="kpi-icon">üéØ</div>
                </div>
                <div class="kpi-value">
                    <span id="hilfsfristPercentage">0</span>%
                </div>
                <div class="kpi-label">
                    <span id="hilfsfristAchieved">0</span> von <span id="hilfsfristTotal">0</span> erreicht
                </div>
                <div class="kpi-threshold-info" id="hilfsfristThresholdInfo">
                    ‚ö´ Status wird berechnet...
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <!-- Line Chart -->
            <div class="chart-card">
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="chart-card">
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="chart-card">
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tagesverlauf Heatmap -->
        <div class="chart-card" style="grid-column: 1 / -1; margin-bottom: 16px;">
            <div class="chart-container" style="height: 280px;">
                <canvas id="heatmapChart"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-card">
            <div class="table-header" style="cursor: pointer;" id="tableToggleHeader">
                <h2>üìä Detaillierte Einsatzliste</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="table-info">
                        Anzahl: <strong id="tableRecordCount">0</strong>
                    </div>
                    <span class="rtw-picker-toggle expanded" id="tableToggleIcon">‚ñº</span>
                </div>
            </div>
            <div class="table-container" id="tableContent">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="call_sign">RTW</th>
                            <th class="sortable" data-sort="nameeventtype">Einsatztyp</th>
                            <th class="sortable" data-sort="isHilfsfristRelevant">Relevanz</th>
                            <th class="sortable" data-sort="time_alarm">Alarmzeit</th>
                            <th class="sortable" data-sort="responseTime">Ausr√ºckezeit</th>
                            <th>Status</th>
                            <th class="sortable" data-sort="travelTime">Anfahrtszeit</th>
                            <th>Status</th>
                            <th class="sortable" data-sort="hilfsfristAchieved">Hilfsfrist</th>
                            <th class="sortable" data-sort="idevent">Event ID</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" class="empty-state">
                                <div class="empty-state-icon">‚è≥</div>
                                <div>Lade Daten...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ArcGIS JS API -->
    <script src="https://js.arcgis.com/4.33/"></script>

    <!-- JavaScript Modules (loaded in dependency order) -->
    <script src="js/01-config.js"></script>
    <script src="js/02-state.js"></script>
    <script src="js/03-calculations.js"></script>
    <script src="js/04-data.js"></script>
    <script src="js/05-ui-kpis.js"></script>
    <script src="js/06-ui-charts.js"></script>
    <script src="js/07-ui-table.js"></script>
    <script src="js/08-ui-modal.js"></script>
    <script src="js/09-ui-filters.js"></script>
    <script src="js/10-main.js"></script>

    <!-- AMD Wrapper for ArcGIS API -->
    <script>
        require([
            "esri/request"
        ], function(esriRequest) {
            // Make esriRequest globally available for all modules
            window.esriRequest = esriRequest;

            // Initialize dashboard
            init();
        });
    </script>
</body>
</html>
